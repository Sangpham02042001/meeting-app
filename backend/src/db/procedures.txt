DELIMITER $$
DROP PROCEDURE IF EXISTS getTeamMembers;
CREATE PROCEDURE getTeamMembers(IN teamId INT)
BEGIN
	SELECT CONCAT(u.firstName, ' ', u.lastName) as userName,
		u.id
	FROM users_teams ut
	INNER JOIN users u ON u.id = ut.userId
	WHERE ut.teamId = teamId; 
END $$
DELIMITER ;

DELIMITER $$
DROP PROCEDURE IF EXISTS getTeamRequestMembers;
CREATE PROCEDURE getTeamRequestMembers(IN teamId INT)
BEGIN 
SELECT CONCAT(u.firstName, ' ', u.lastName) as userName,
		u.id
FROM request_users_teams rut
INNER JOIN users u ON u.id = rut.requestUserId
WHERE rut.teamId = teamId;
END $$
DELIMITER ;

DELIMITER $$
DROP PROCEDURE IF EXISTS getTeamInvitedUsers;
CREATE PROCEDURE getTeamInvitedUsers(
	IN teamId INT
)
BEGIN
	SELECT CONCAT(u.firstName, ' ', u.lastName) as userName,
		u.id
	FROM invited_users_teams iut
	INNER JOIN users u ON u.id = iut.invitedUserId
	WHERE iut.teamId = teamId;
END $$
DELIMITER ;

DELIMITER $$
DROP PROCEDURE IF EXISTS updateBasicUserInfo;
CREATE PROCEDURE updateBasicUserInfo(
	IN userId INT,
    IN firstName VARCHAR(255),
    IN lastName VARCHAR(255),
    IN avatar VARCHAR(255)
)
BEGIN
	IF firstName != '' THEN
		UPDATE users
        SET firstName = firstName
        WHERE id = userId;
    END IF;
    
    IF lastName != '' THEN
		UPDATE users
        SET lastName = lastName
        WHERE id = userId;
    END IF;
    
    IF avatar != '' THEN
		UPDATE users
		SET avatar = avatar
		WHERE id = userId;
    END IF;
    
    SELECT u.id, u.lastName, u.firstName FROM users u
    WHERE id = userId;
END $$
DELIMITER ;

DELIMITER $$
DROP PROCEDURE IF EXISTS removeRequestUsers;
CREATE PROCEDURE removeRequestUsers(
	users VARCHAR(255),
    teamId INT,
	confirmFlag BOOLEAN
)
BEGIN
	DECLARE teamName VARCHAR(255);
    DECLARE hostName VARCHAR(255);
    DECLARE hostId INT;
    DECLARE tmp VARCHAR(10);
	DELETE FROM request_users_teams rut
    WHERE rut.teamId = teamId AND FIND_IN_SET(rut.requestUserId, users);
    IF confirmFlag THEN
		SET @array = users;
        
        SELECT CONCAT(u.firstName, " ", u.lastName),
			   t.name, t.hostId INTO hostName, teamName, hostId
        FROM teams t
        INNER JOIN users u ON u.id = t.hostId
        WHERE t.id = teamId;
        SET @content = CONCAT(hostName, " has confirmed your request to join ",teamName);
        SET @relativeLink = CONCAT("/teams/",teamId);
        WHILE (LOCATE(',', @array) > 0)
        DO
			SET @id = CONVERT(ELT(1, @array), SIGNED INT);
            SET @array = SUBSTRING(@array, LOCATE(',',@array) + 1);
            IF @id != '' THEN
				INSERT INTO users_teams VALUES(NOW(), NOW(), @id, teamId);
				SET tmp = createTeamNotification(@content, @relativeLink, @id, teamId, hostId);
            END IF;
        END WHILE;
    END IF;
    SELECT 'Successfully' message;
END$$
DELIMITER ;

DELIMITER $$
DROP PROCEDURE IF EXISTS removeInvitations;
CREATE PROCEDURE removeInvitations(
	teams VARCHAR(255),
    userId INT,
	confirmFlag BOOLEAN
)
BEGIN
	DELETE FROM invited_users_teams iut
    WHERE iut.invitedUserId = userId AND FIND_IN_SET(iut.teamId, teams);
    IF confirmFlag THEN
		SET @array = teams;
        WHILE (LOCATE(',', @array) > 0)
        DO
			SET @id = CONVERT(ELT(1, @array), SIGNED INT);
            SET @array = SUBSTRING(@array, LOCATE(',',@array) + 1);
            IF @id != '' THEN
				INSERT INTO users_teams VALUES(NOW(), NOW(), userId, @id);
            END IF;
        END WHILE;
    END IF;
    SELECT 'Successfully' message;
END $$
DELIMITER ;

DELIMITER $$
DROP PROCEDURE IF EXISTS inviteUsers;
CREATE PROCEDURE inviteUsers(
	IN teamId INT,
    IN users VARCHAR(255)
)
BEGIN 
	DECLARE hostName VARCHAR(255);
    DECLARE teamName VARCHAR(255);
    DECLARE hostId INT;
    DECLARE tmp VARCHAR(10);
    SET @array = users;
        
	SELECT CONCAT(u.firstName, " ", u.lastName),
		   t.name, t.hostId INTO hostName, teamName, hostId
	FROM teams t
	INNER JOIN users u ON u.id = t.hostId
	WHERE t.id = teamId;
	SET @content = CONCAT(hostName, " has invited you to join ",teamName);
	SET @relativeLink = CONCAT("/teams/",teamId);
	WHILE (LOCATE(',', @array) > 0)
		DO
			SET @id = CONVERT(ELT(1, @array), SIGNED INT);
			SET @array = SUBSTRING(@array, LOCATE(',',@array) + 1);
			IF @id != '' THEN
				INSERT INTO invited_users_teams VALUES(NOW(), NOW(), @id, teamId);
				SET tmp = createTeamNotification(@content, @relativeLink, @id, teamId, hostId);
			END IF;
	END WHILE;
    SELECT 'Invite Successfully' message;
END$$
DELIMITER ;

DROP PROCEDURE IF EXISTS searchUsers;
DELIMITER $$
CREATE PROCEDURE searchUsers(
	IN userId INT,
    IN text VARCHAR(255)
)
BEGIN 
	DECLARE my_text VARCHAR(255) DEFAULT CONCAT('%', text, '%');
	SELECT CONCAT(u.firstName, ' ', u.lastName) as userName,
			u.id, u.email
    FROM users u
    WHERE u.id != userId AND CONCAT(u.firstName, ' ', u.lastName) LIKE my_text;
END $$
DELIMITER ;

DELIMITER $$
DROP PROCEDURE IF EXISTS updateBasicTeamInfo;
CREATE PROCEDURE updateBasicTeamInfo(
	IN teamId INT,
    IN teamName VARCHAR(255),
    IN coverPhoto VARCHAR(255),
    IN teamType VARCHAR(255)
)
BEGIN
	IF teamName != '' THEN
		UPDATE teams 
        SET name = teamName
        WHERE id = teamId;
	END IF;
        
	IF teamType != '' THEN
		UPDATE teams
        SET teamType = teamType
        WHERE id = teamId;
	END IF;
    
    IF coverPhoto != '' THEN
		UPDATE teams
        SET coverPhoto = coverPhoto
        WHERE id = teamId;
	END IF;
    
	SELECT t.name, t.teamType, t.coverPhoto FROM teams t
	WHERE t.id = teamId;
END$$
DELIMITER ;

DELIMITER $$
DROP PROCEDURE IF EXISTS getTeamMessages;
CREATE PROCEDURE getTeamMessages(
	IN teamId INT,
    IN myOffset INT,
    IN num INT
)
BEGIN 
	IF CONVERT(myOffset, SIGNED INT) = 0 THEN
        SELECT m.id, m.content, m.photo, m.createdAt, m.userId
        FROM messages m
        WHERE m.teamId = teamId
        ORDER BY m.createdAt DESC
        LIMIT 15;
    ELSE
		SELECT m.id, m.content, m.photo, m.createdAt, m.userId
        FROM messages m
        WHERE m.teamId = teamId
        ORDER BY m.createdAt DESC
        LIMIT myOffset, num;
    END IF;
END $$
DELIMITER ;