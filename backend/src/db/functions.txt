DROP FUNCTION IF EXISTS createMessageNotification;
DELIMITER $$
CREATE FUNCTION createMessageNotification(
	content VARCHAR(255),
    relativeLink VARCHAR(255),
    userId INT,
    createdBy INT,
    teamId INT,
    conversationId INT
)
RETURNS VARCHAR(5)
DETERMINISTIC
BEGIN 
	DECLARE _createdBy INT;
    DECLARE _userId INT;
	IF conversationId IS NOT NULL THEN 
		SELECT n.createdBy INTO _createdBy
        FROM notifications n 
        WHERE n.conversationId = conversationId AND n.userId = userId;
        IF createdBy = _createdBy THEN
			UPDATE notifications n
            SET n.createdAt = NOW(),
				n.isRead = false
            WHERE n.conversationId = conversationId AND n.createdBy = createdBy;
		ELSE 
			INSERT INTO notifications
             SET content = content,
				 relativeLink = relativeLink,
				userId = userId,
				createdAt = NOW(),
				updatedAt = NOW(),
				createdBy = createdBy,
                conversationId = conversationId;
        END IF;
    END IF;
	
    IF teamId IS NOT NULL THEN 
		SELECT n.createdBy INTO _createdBy
        FROM notifications n 
        WHERE n.teamId = teamId AND n.userId = userId;
        IF _createdBy = createdBy THEN
			UPDATE notifications n
            SET n.createdAt = NOW(), n.isRead = false
            WHERE n.teamId = teamId AND n.userId = userId;
        ELSEIF _createdBy IS NOT NULL THEN
			UPDATE notifications n
            SET n.createdAt = NOW(),	
				n.createdBy = createdBy,
                n.content = content
            WHERE n.teamId = teamId AND n.userId = userId;
        ELSE 
			INSERT INTO notifications
			SET content = content,
				relativeLink = relativeLink,
				userId = userId,
				createdAt = NOW(),
				updatedAt = NOW(),
				createdBy = createdBy,
                teamId = teamId;
        END IF;
	END IF;
    RETURN "";
END $$
DELIMITER ;